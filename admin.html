<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Админ-панель академии</title>
    <style>
        body{font-family:Arial,sans-serif;background:#1a3c1a;color:#fff;padding:30px}
        .container{
            max-width:1200px;margin:0 auto;background:rgba(255,255,255,.1);
            border-radius:20px;padding:30px;backdrop-filter:blur(10px)
        }
        table{
            width:100%;border-collapse:collapse;margin-top:20px;
            background:rgba(255,255,255,.15);border-radius:15px;overflow:hidden
        }
        th,td{padding:15px;text-align:left;border-bottom:1px solid rgba(255,255,255,.2)}
        th{
            background:linear-gradient(45deg,#ff6600,#ffcc00);
            color:#1a1a1a;font-weight:700
        }
        tr:hover{background:rgba(255,255,255,.2)}
        .top3{background:linear-gradient(45deg,gold,orange)!important;font-weight:700}
        .danger{
            padding:15px 30px;background:#cc0000;color:#fff;border:none;
            border-radius:20px;cursor:pointer;font-size:1.1em;margin-bottom:20px
        }
        .stats{display:flex;gap:20px;margin-bottom:20px;flex-wrap:wrap}
        .stat{
            background:rgba(255,255,255,.2);padding:20px;border-radius:15px;text-align:center
        }
        .delete-btn{
            padding:5px 10px;border-radius:12px;border:none;cursor:pointer;
            background:#cc0000;color:#fff;font-size:.8em
        }
    </style>
    <script>
        // простой пароль на вход (не защищает от просмотра кода)
        (function(){
            var ok = prompt('Введите пароль администратора:');
            if(ok !== 'yugen_kairen'){
                document.write('Доступ запрещён');
                throw new Error('Access denied');
            }
        })();
    </script>
</head>
<body>
<div class="container">
    <h1>Админ-панель Академии</h1>
    <button class="danger" type="button" onclick="deleteAll()">Очистить всё</button>

    <div class="stats" id="stats"></div>
    <table id="resultsTable">
        <thead>
        <tr>
            <th>Место</th><th>Ник</th><th>Балл</th><th>Статус</th><th>Дата</th><th>Действие</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
const API_URL='https://sheetdb.io/api/v1/4ssoqxhf0fnia';
let lastResults=[];

async function loadResults(){
    try{
        const response=await fetch(API_URL);
        lastResults=await response.json();

        lastResults.sort((a,b)=>{
            const ap=a.status==='Прошёл'?1:0;
            const bp=b.status==='Прошёл'?1:0;
            if(bp-ap!==0)return bp-ap;
            return (parseInt(b.score||0)-parseInt(a.score||0));
        });

        const total=lastResults.length;
        const passed=lastResults.filter(r=>r.status==='Прошёл').length;

        document.getElementById('stats').innerHTML=
            `<div class="stat">Всего: ${total}</div>
             <div class="stat">Сдали: ${passed}</div>`;

        renderFromLast();
    }catch(e){
        document.querySelector('#resultsTable tbody').innerHTML=
            '<tr><td colspan="6">Ошибка загрузки…</td></tr>';
    }
}

function renderFromLast(){
    const tbodyHtml=lastResults.map((r,i)=>`
        <tr ${i<3?'class="top3"':''}>
            <td>${i+1}</td>
            <td><strong>${r.name||'-'}</strong></td>
            <td>${r.score!==undefined?r.score:'0'} / 15</td>
            <td>${r.status||'-'}</td>
            <td>${r.date||'-'}</td>
            <td><button class="delete-btn" type="button" onclick="deleteRow(${i})">Удалить</button></td>
        </tr>
    `).join('');
    document.querySelector('#resultsTable tbody').innerHTML=tbodyHtml||'<tr><td colspan="6">Нет данных</td></tr>';
}

async function deleteRow(index){
    if(!confirm('Удалить этот результат?'))return;
    const row=lastResults[index];
    if(!row)return;

    const name=row.name||'';
    const date=row.date||'';

    try{
        await fetch(API_URL+'/search',{
            method:'DELETE',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({name:name,date:date})
        });
        lastResults.splice(index,1);
        renderFromLast();
    }catch(e){
        alert('Не удалось удалить запись.');
    }
}

async function deleteAll(){
    if(!confirm('Точно очистить ВСЕ результаты?'))return;
    try{
        await fetch(API_URL+'/all',{method:'DELETE'});
        lastResults=[];
        renderFromLast();
    }catch(e){
        alert('Не удалось очистить таблицу.');
    }
}

loadResults();
setInterval(loadResults,10000);
</script>
</body>
</html>
